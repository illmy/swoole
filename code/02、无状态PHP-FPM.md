# 无状态PHP_FPM

## 无状态的优势
无状态设计是可扩展的。所有的状态都保存在外部存储中。理论上，我们可
以通过增加更多的同样的进程来扩展，以服务于更多的并发请求，只要外部
存储可以扩展到处理 PHP 进程的请求的规模。

另一方面，由于每次请求都会创建和销毁整个世界，所以内存泄漏的风险较
小，所以相比于在进程内维护状态，忘记管理状态的生命周期，然后造成内
存泄漏，更加可靠。这些都是 PHP-FPM 被广泛采用的原因之一，它是一个
更稳健的设计，但牺牲了性能，因为大多数 Web 应用程序可能没有这么多
并发用户。
可以将系统的工作负载分派给负载均衡器，然后将工作负载平均分配给多个
相同的无状态服务器以扩大或缩小系统的规模。 对于这种类型的系统，可
以使用多种负载平衡算法。 如果服务器大小不同，则采用加权轮询； 如果
每个服务器的性能都不相同并且请求的资源消耗没有太大变化，可以选择连
接最少。 根据系统的要求，也可以使用其他的负载均衡算法。

无状态响应如 HTTP 响应总是可以被大多数缓存服务器如 Varnish 或 Nginx
和 CDN 缓存。这是无状态系统的另一个优点。

## 无状态设计的弊端  
第一个问题是有些状态不能在不同请求之间共享。这些可共享状态的构建可
能非常昂贵，比如从数据库中获取变量或者从远程服务器中获取变量。在无
状态设计中，这些变量在每个请求中都要反复创建和销毁。
第二个问题是外部存储可能无法随着进程数量的增加而扩展。建立过多的数
据库连接可能会明显降低性能。我们可能需要一个中间层代理来限制与数据
库的最大连接数，但这也会降低整体性能，因为有一个中间层成本。

## 小结  
无状态是一把双刃剑，一方面你可以享受到扩展性，另一方面你可能会因为
在外部保存状态而导致性能下降。
通过对系统的一个组件进行不同的域划分，有状态组件也可以被看作是无状
态组件。如果组件保持状态仅是高速缓存数据，则可以将一个有状态系统视
为无状态组件。 正确而明智地管理状态是将系统性能提高 10 倍至 100 倍
的关键。